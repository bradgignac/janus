#!/usr/bin/env ruby

require 'colored'
require 'gli'
require 'janus/version'
require 'janus/command/initialize'
require 'janus/command/record'
require 'janus/command/validate'
require 'janus/configuration'

include GLI::App

program_desc 'Automated visual regression testing on Sauce Labs.'
version Janus::VERSION

desc 'Sauce Labs Username'
arg_name 'username'
flag [:u, :username]

desc 'Sauce Labs API Key'
arg_name 'access_key'
flag [:k, :access_key]

desc 'Create a Janus configuration file'
command :init do |c|
  c.action do |global, options, args|
    init = Janus::Command::Initialize.new
    init.execute
  end
end

desc 'Generate screenshots for all tests'
command :record do |c|
  c.action do |global, options, args|
    record = Janus::Command::Record.new($configuration)
    record.execute
  end
end

desc 'Validate screenshots for all tests'
command :validate do |c|
  c.action do |global, options, args|
    validate = Janus::Command::Validate.new($configuration)
    validate.execute
  end
end

pre do |global, command, options, args|
  $configuration = Janus::Configuration.load(global, options) unless command.name == :init
  true
end

on_error do |e|
  puts e.message.red
end

exit run(ARGV)
